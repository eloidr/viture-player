<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>VITURE Video Player PWA</title>

    <link rel="manifest" href="manifest.json">
    <link rel="apple-touch-icon" href="icon-512.png">

    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-fullscreen">
    <meta name="apple-mobile-web-app-title" content="Viture Player">
    <meta name="application-name" content="Viture Player">
    <meta name="msapplication-TileColor" content="#000000">
    <meta name="theme-color" content="#000000">
    <meta name="screen-orientation" content="landscape">

    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        html, body {
            font-family: Arial, sans-serif;
            background: #000;
            overflow: hidden;
            width: 100%;
            height: 100%;
            position: fixed;
            touch-action: manipulation;
            -webkit-user-select: none;
            -moz-user-select: none;
            -ms-user-select: none;
            user-select: none;
        }
        .install-banner {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 12px 20px;
            text-align: center;
            font-size: 14px;
            z-index: 2000;
            transform: translateY(-100%);
            transition: transform 0.3s ease;
        }
        .install-banner.show {
            transform: translateY(0);
        }
        .install-banner button {
            background: rgba(255,255,255,0.2);
            border: 1px solid rgba(255,255,255,0.3);
            color: white;
            padding: 6px 12px;
            border-radius: 20px;
            margin: 0 5px;
            cursor: pointer;
            font-size: 12px;
        }
        .install-banner button:hover {
            background: rgba(255,255,255,0.3);
        }
        .video-container {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: #000;
            border-radius: 8px;
            overflow: hidden;
            box-shadow: 0 4px 20px rgba(0,0,0,0.5);
            touch-action: none;
            cursor: move;
            z-index: 10;
            width: 400px;
            height: 300px;
            will-change: transform, width, height;
        }
        @media screen and (max-width: 1024px) {
            .video-container {
                width: 60vw;
                height: 40vh;
                min-width: 280px;
                min-height: 200px;
            }
        }
        @media screen and (min-width: 1025px) {
            .video-container {
                resize: both;
                overflow: hidden;
                min-width: 300px;
                min-height: 200px;
                max-width: 90vw;
                max-height: 90vh;
            }
            .video-container::after {
                content: '';
                position: absolute;
                bottom: 0;
                right: 0;
                width: 20px;
                height: 20px;
                background: linear-gradient(-45deg, transparent 30%, rgba(255,255,255,0.1) 30%, rgba(255,255,255,0.1) 70%, transparent 70%);
                pointer-events: none;
            }
        }
        video {
            width: 100%;
            height: 100%;
            display: block;
            object-fit: contain;
        }
        .controls {
            position: fixed;
            top: 20px;
            right: 20px;
            display: flex;
            flex-direction: column;
            gap: 10px;
            z-index: 1000;
        }
        .control-btn {
            width: 50px;
            height: 50px;
            border: none;
            border-radius: 50%;
            background: rgba(0,0,0,0.8);
            color: white;
            font-size: 20px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s ease;
            touch-action: manipulation;
            border: 2px solid rgba(255,255,255,0.2);
        }
        @media screen and (min-width: 1025px) {
            .control-btn {
                width: 60px;
                height: 60px;
                font-size: 24px;
            }
            .control-btn:hover {
                background: rgba(0,0,0,0.9);
                transform: scale(1.1);
                border-color: rgba(255,255,255,0.4);
            }
        }
        .control-btn:active {
            background: rgba(0,0,0,0.9);
            transform: scale(1.1);
        }
        .orientation-lock {
            position: fixed;
            bottom: 20px;
            left: 20px;
            background: rgba(0,128,0,0.8);
            color: white;
            padding: 8px 16px;
            border-radius: 20px;
            font-size: 12px;
            z-index: 1000;
            opacity: 0;
            transition: opacity 0.3s ease;
        }
        .orientation-lock.active {
            opacity: 1;
        }
        .orientation-lock.warning {
            background: rgba(255,165,0,0.9);
        }
        #fileInput {
            display: none;
        }
    </style>
</head>
<body>
    <div class="install-banner" id="installBanner">
        Instala esta app para un control total de la orientaciÃ³n y experiencia mejorada.
        <button id="installBtn">Instalar</button>
        <button id="dismissBtn">Cerrar</button>
    </div>

    <input type="file" id="fileInput" accept="video/*">

    <div class="video-container" id="videoContainer">
        <video id="videoPlayer" controls preload="metadata"></video>
    </div>

    <div class="controls">
        <button class="control-btn" id="loadBtn" title="Cargar video">ðŸ“‚</button>
        <button class="control-btn" id="lockBtn" title="Bloquear orientaciÃ³n">ðŸ”“</button>
        <button class="control-btn" id="centerBtn" title="Centrar video">âŠ™</button>
    </div>

    <div class="orientation-lock" id="orientationIndicator"></div>

    <script>
        // Referencias a elementos
        const videoContainer = document.getElementById('videoContainer');
        const videoPlayer = document.getElementById('videoPlayer');
        const fileInput = document.getElementById('fileInput');
        const loadBtn = document.getElementById('loadBtn');
        const lockBtn = document.getElementById('lockBtn');
        const centerBtn = document.getElementById('centerBtn');
        const orientationIndicator = document.getElementById('orientationIndicator');
        const installBanner = document.getElementById('installBanner');
        const installBtn = document.getElementById('installBtn');
        const dismissBtn = document.getElementById('dismissBtn');

        const isMobile = /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent) || window.innerWidth <= 1024;
        const isTouch = 'ontouchstart' in window || navigator.maxTouchPoints > 0;

        // ===== PWA INSTALLATION =====
        let deferredPrompt;
        let isInstalled = window.matchMedia('(display-mode: standalone)').matches || window.navigator.standalone;

        window.addEventListener('beforeinstallprompt', (e) => {
            e.preventDefault();
            deferredPrompt = e;
            if (!isInstalled) {
                installBanner.classList.add('show');
            }
        });

        installBtn.addEventListener('click', async () => {
            if (deferredPrompt) {
                deferredPrompt.prompt();
                const { outcome } = await deferredPrompt.userChoice;
                if (outcome === 'accepted') {
                    installBanner.classList.remove('show');
                    isInstalled = true;
                }
                deferredPrompt = null;
            }
        });

        dismissBtn.addEventListener('click', () => {
            installBanner.classList.remove('show');
        });

        window.matchMedia('(display-mode: standalone)').addEventListener('change', (e) => {
            isInstalled = e.matches;
            if (isInstalled) {
                installBanner.classList.remove('show');
                lockOrientation();
            }
        });

        // ===== BLOQUEO DE ORIENTACIÃ“N =====
        let orientationLocked = false;

        async function lockOrientation() {
            try {
                if (screen.orientation && screen.orientation.lock) {
                    await screen.orientation.lock('landscape');
                    orientationLocked = true;
                    orientationIndicator.textContent = 'OrientaciÃ³n bloqueada';
                    orientationIndicator.classList.remove('warning');
                    orientationIndicator.classList.add('active');
                    lockBtn.innerHTML = 'ðŸ”’';
                    lockBtn.style.background = 'rgba(0,128,0,0.8)';
                    setTimeout(() => { orientationIndicator.classList.remove('active'); }, 2000);
                    return true;
                }
            } catch (error) {
                console.warn('No se pudo bloquear orientaciÃ³n:', error);
                orientationLocked = false;
                orientationIndicator.textContent = 'Bloqueo FALLIDO. Gira tu dispositivo.';
                orientationIndicator.classList.add('warning', 'active');
                lockBtn.innerHTML = 'ðŸ”“';
                lockBtn.style.background = 'rgba(128,0,0,0.8)';
                setTimeout(() => { orientationIndicator.classList.remove('active', 'warning'); }, 3000);
            }
            return false;
        }

        function unlockOrientation() {
            try {
                if (screen.orientation && screen.orientation.unlock) {
                    screen.orientation.unlock();
                    orientationLocked = false;
                    lockBtn.innerHTML = 'ðŸ”“';
                    lockBtn.style.background = 'rgba(0,0,0,0.8)';
                    orientationIndicator.textContent = 'OrientaciÃ³n liberada';
                    orientationIndicator.classList.add('active');
                    setTimeout(() => { orientationIndicator.classList.remove('active'); }, 2000);
                }
            } catch (error) {
                console.warn('Error al liberar orientaciÃ³n:', error);
            }
        }
        
        document.addEventListener('visibilitychange', () => {
            if (document.visibilityState === 'visible' && isInstalled) {
                lockOrientation();
            }
        });

        window.addEventListener('load', async () => {
            if (isInstalled) {
                await lockOrientation();
            }
        });

        lockBtn.addEventListener('click', async () => {
            if (orientationLocked) {
                unlockOrientation();
            } else {
                await lockOrientation();
            }
        });

        // ===== CONTROLES DE VIDEO =====
        loadBtn.addEventListener('click', () => fileInput.click());

        centerBtn.addEventListener('click', () => {
            videoContainer.style.left = '50%';
            videoContainer.style.top = '50%';
            videoContainer.style.transform = 'translate(-50%, -50%)';
        });

        fileInput.addEventListener('change', (e) => {
            const file = e.target.files[0];
            if (file) {
                if (videoPlayer.src && videoPlayer.src.startsWith('blob:')) {
                    URL.revokeObjectURL(videoPlayer.src);
                }
                videoPlayer.src = URL.createObjectURL(file);
            }
        });

        // ===== FUNCIONALIDAD DE ARRASTRAR Y REDIMENSIONAR =====
        let isDragging = false;
        let isPinching = false;
        let startX, startY, initialLeft, initialTop, initialDistance, initialWidth, initialHeight;

        function getDistance(touches) {
            const dx = touches[0].clientX - touches[1].clientX;
            const dy = touches[0].clientY - touches[1].clientY;
            return Math.sqrt(dx * dx + dy * dy);
        }

        function constrainToScreen(x, y, width, height) {
            const maxX = window.innerWidth - width;
            const maxY = window.innerHeight - height;
            return {
                x: Math.max(0, Math.min(maxX, x)),
                y: Math.max(0, Math.min(maxY, y))
            };
        }

        function setPosition(x, y) {
            videoContainer.style.left = x + 'px';
            videoContainer.style.top = y + 'px';
            videoContainer.style.transform = 'none';
        }

        function handleDragStart(e) {
            isDragging = true;
            isPinching = false;
            const touch = e.touches ? e.touches[0] : e;
            startX = touch.clientX;
            startY = touch.clientY;
            const rect = videoContainer.getBoundingClientRect();
            initialLeft = rect.left;
            initialTop = rect.top;
        }

        function handlePinchStart(e) {
            isDragging = false;
            isPinching = true;
            initialDistance = getDistance(e.touches);
            const rect = videoContainer.getBoundingClientRect();
            initialWidth = rect.width;
            initialHeight = rect.height;
        }
        
        // Eventos de arrastre para mÃ³vil (tÃ¡ctil)
        videoContainer.addEventListener('touchstart', (e) => {
            if (e.target === videoPlayer) return; // FIX: Permite usar controles del video

            if (e.touches.length === 1) {
                e.preventDefault();
                handleDragStart(e);
            } else if (e.touches.length === 2) {
                e.preventDefault();
                handlePinchStart(e);
            }
        }, { passive: false });

        document.addEventListener('touchmove', (e) => {
            if (isDragging && e.touches.length === 1) {
                e.preventDefault();
                const deltaX = e.touches[0].clientX - startX;
                const deltaY = e.touches[0].clientY - startY;
                const newX = initialLeft + deltaX;
                const newY = initialTop + deltaY;
                const rect = videoContainer.getBoundingClientRect();
                const constrained = constrainToScreen(newX, newY, rect.width, rect.height);
                setPosition(constrained.x, constrained.y);
            } else if (isPinching && e.touches.length === 2) {
                e.preventDefault();
                const currentDistance = getDistance(e.touches);
                const scale = currentDistance / initialDistance;
                const newWidth = Math.max(200, Math.min(window.innerWidth * 0.95, initialWidth * scale));
                const newHeight = Math.max(150, Math.min(window.innerHeight * 0.95, initialHeight * scale));
                videoContainer.style.width = newWidth + 'px';
                videoContainer.style.height = newHeight + 'px';

                const rect = videoContainer.getBoundingClientRect();
                const constrained = constrainToScreen(rect.left, rect.top, newWidth, newHeight);
                setPosition(constrained.x, constrained.y);
            }
        }, { passive: false });

        document.addEventListener('touchend', (e) => {
            if (e.touches.length < 2) isPinching = false;
            if (e.touches.length < 1) isDragging = false;
        });

        // Eventos de arrastre para PC (ratÃ³n)
        videoContainer.addEventListener('mousedown', (e) => {
            if (e.target === videoPlayer) return; // FIX: Permite usar controles del video
            e.preventDefault();
            handleDragStart(e);
            document.body.style.cursor = 'grabbing';
            videoContainer.style.cursor = 'grabbing';
        });

        document.addEventListener('mousemove', (e) => {
            if (!isDragging) return;
            const deltaX = e.clientX - startX;
            const deltaY = e.clientY - startY;
            const newX = initialLeft + deltaX;
            const newY = initialTop + deltaY;
            const rect = videoContainer.getBoundingClientRect();
            const constrained = constrainToScreen(newX, newY, rect.width, rect.height);
            setPosition(constrained.x, constrained.y);
        });
        
        document.addEventListener('mouseup', () => {
            if (isDragging) {
                isDragging = false;
                document.body.style.cursor = '';
                videoContainer.style.cursor = 'move';
            }
        });

        // Atajos de teclado
        if (!isMobile) {
            document.addEventListener('keydown', (e) => {
                switch(e.key.toLowerCase()) {
                    case ' ': e.preventDefault(); videoPlayer.paused ? videoPlayer.play() : videoPlayer.pause(); break;
                    case 'c': e.preventDefault(); centerBtn.click(); break;
                    case 'o': e.preventDefault(); loadBtn.click(); break;
                    case 'l': e.preventDefault(); lockBtn.click(); break;
                }
            });
        }
        
        // Limpieza al salir
        window.addEventListener('beforeunload', () => {
            try {
                if (screen.orientation && screen.orientation.unlock) {
                    screen.orientation.unlock();
                }
            } catch (error) {}
            if (videoPlayer.src && videoPlayer.src.startsWith('blob:')) {
                URL.revokeObjectURL(videoPlayer.src);
            }
        });

        // Service Worker para PWA (requiere archivo sw.js)
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('sw.js')
                    .then(registration => console.log('Service Worker registrado con Ã©xito:', registration))
                    .catch(error => console.log('Error registrando Service Worker:', error));
            });
        }
    </script>
</body>
</html>
